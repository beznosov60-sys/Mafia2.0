<section class="client-card-page" v-if="client">
  <div class="card hero-card">
    <div class="hero-main">
      <div class="hero-title">
        <h1 class="section-title">{{ client.fullName }}</h1>
        <span v-if="isArchived" class="badge badge-archived">Клиент в архиве</span>
      </div>
      <div class="hero-meta">
        <div class="meta-block">
          <span class="meta-label">Менеджер</span>
          <span class="meta-value">{{ client.manager?.name || 'Не назначен' }}</span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Контакты</span>
          <span class="meta-value">
            <span v-if="client.phone">{{ client.phone }}</span>
            <span v-if="client.email">{{ client.email }}</span>
          </span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Город</span>
          <span class="meta-value">{{ client.city || '—' }}</span>
        </div>
        <div class="meta-block">
          <span class="meta-label">Стадия</span>
          <span class="meta-value">{{ client.stage }}</span>
        </div>
      </div>
    </div>
    <div class="hero-actions">
      <button type="button" class="ghost-btn" @click="goToEdit">Редактировать</button>
      <button type="button" class="ghost-btn" @click="toggleArchive">
        {{ isArchived ? 'Вернуть в работу' : 'Архивировать' }}
      </button>
    </div>
  </div>

  <div class="card stage-card">
    <h2>Прогресс дела</h2>
    <ol class="stage-timeline">
      <li
        v-for="item in stages"
        :key="item.stage"
        :class="['stage-item', item.status]"
      >
        <span class="stage-dot" :style="{ backgroundColor: item.color }"></span>
        <div class="stage-info">
          <span class="stage-name">{{ item.stage }}</span>
          <span v-if="item.status === 'current' && client.subStage" class="stage-sub">{{ client.subStage }}</span>
        </div>
      </li>
    </ol>
    <div v-if="subStageList.length" class="sub-stage-list">
      <span class="sub-stage-title">Подэтапы:</span>
      <ul>
        <li
          v-for="name in subStageList"
          :key="name"
          :class="{ active: name === client.subStage }"
        >
          {{ name }}
        </li>
      </ul>
    </div>
  </div>

  <div class="info-grid">
    <div class="card info-card">
      <h2>Контакты</h2>
      <dl>
        <div>
          <dt>Телефон</dt>
          <dd>{{ client.phone || '—' }}</dd>
        </div>
        <div>
          <dt>Почта</dt>
          <dd>{{ client.email || '—' }}</dd>
        </div>
        <div>
          <dt>Менеджер</dt>
          <dd>{{ client.manager?.name || 'Не назначен' }}</dd>
        </div>
        <div>
          <dt>Телефон менеджера</dt>
          <dd>{{ client.manager?.phone || '—' }}</dd>
        </div>
      </dl>
    </div>

    <div class="card info-card">
      <h2>Суд</h2>
      <p v-if="client.court" class="court-date">
        {{ client.court?.title || 'Заседание' }} —
        <strong>{{ client.court?.date ? new Date(client.court.date).toLocaleDateString('ru-RU') : 'дата не назначена' }}</strong>
      </p>
      <p v-else class="empty-state">Информация о суде пока не указана.</p>
      <p v-if="courtBadge" class="court-badge">Тип суда: {{ courtBadge }}</p>
      <p class="notes" v-if="client.notes">{{ client.notes }}</p>
    </div>

    <div class="card info-card tasks-card">
      <h2>Задачи</h2>
      <ul v-if="tasks.length" class="tasks-list">
        <li v-for="task in tasks" :key="task.id" :class="{ done: task.completed }">
          <div class="task-title">{{ task.title }}</div>
          <div class="task-meta">
            <span v-if="task.dueDate">{{ new Date(task.dueDate).toLocaleDateString('ru-RU') }}</span>
            <span>{{ task.completed ? 'Выполнено' : 'В работе' }}</span>
          </div>
        </li>
      </ul>
      <p v-else class="empty-state">Задач пока нет.</p>
    </div>

    <div class="card info-card finance-card">
      <h2>Финансы</h2>
      <div class="finance-summary">
        <div class="summary-item">
          <span class="summary-label">Сумма договора</span>
          <span class="summary-value">{{ formattedContractAmount }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Поступления</span>
          <span class="summary-value positive">{{ formattedPaymentsTotal }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Расходы</span>
          <span class="summary-value negative">{{ formattedExpensesTotal }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Баланс</span>
          <span class="summary-value">{{ formattedBalance }}</span>
        </div>
      </div>
      <div class="finance-details">
        <div>
          <h3>Платежи</h3>
          <ul v-if="payments.length">
            <li v-for="payment in payments" :key="payment.id">
              <span>{{ new Date(payment.date).toLocaleDateString('ru-RU') }}</span>
              <strong>{{ formatMoney(payment.amount) }}</strong>
              <span class="detail-note">{{ payment.comment }}</span>
            </li>
          </ul>
          <p v-else class="empty-state">Нет поступлений.</p>
        </div>
        <div>
          <h3>Расходы</h3>
          <ul v-if="expenses.length">
            <li v-for="expense in expenses" :key="expense.id">
              <span>{{ new Date(expense.date).toLocaleDateString('ru-RU') }}</span>
              <strong>{{ formatMoney(expense.amount) }}</strong>
              <span class="detail-note">{{ expense.comment }}</span>
            </li>
          </ul>
          <p v-else class="empty-state">Нет расходов.</p>
        </div>
      </div>
    </div>

    <div class="card info-card updates-card">
      <h2>Последние события</h2>
      <ul v-if="updates.length" class="updates-list">
        <li v-for="update in updates" :key="update.id">
          <div class="update-date">{{ new Date(update.date).toLocaleDateString('ru-RU') }}</div>
          <p class="update-text">{{ update.text }}</p>
        </li>
      </ul>
      <p v-else class="empty-state">История пока пустая.</p>
    </div>
  </div>
</section>

<p v-else class="empty-state">Клиент не найден.</p>
