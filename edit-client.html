<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card col-md-8 p-4 shadow-lg">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="card-title mb-0">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
                <div>
                    <button id="favoriteBtn" class="btn btn-warning icon-btn me-2" data-favorite="false" title="–ò–∑–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç">‚òÜ</button>
                    <button class="btn btn-primary icon-btn me-2" onclick="generateContractPDF()" title="–°–∫–∞—á–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä">‚äú</button>
                    <button class="btn btn-secondary icon-btn" id="historyToggle" title="–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á">üïí</button>
                </div>
            </div>
            <div class="card-body">
                <!-- –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <h5 class="mb-3">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                <div class="mb-3">
                    <label for="clientId" class="form-label">ID –∫–ª–∏–µ–Ω—Ç–∞</label>
                    <input type="text" class="form-control" id="clientId" disabled>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="firstName" class="form-label">–ò–º—è</label>
                        <input type="text" class="form-control" id="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="middleName" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
                        <input type="text" class="form-control" id="middleName" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç—á–µ—Å—Ç–≤–æ">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="lastName" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                        <input type="text" class="form-control" id="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="birthDate" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                        <input type="date" class="form-control" id="birthDate">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="tel" class="form-control" id="phone" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω (10-12 —Ü–∏—Ñ—Ä)" required>
                    </div>
                </div>
                <!-- –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
                <div class="accordion" id="accordionPassport">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="passportHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#passportCollapse" aria-expanded="false" aria-controls="passportCollapse">
                                –ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                            </button>
                        </h2>
                        <div id="passportCollapse" class="accordion-collapse collapse" aria-labelledby="passportHeading" data-bs-parent="#accordionPassport">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="passportSeries" class="form-label">–°–µ—Ä–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                                        <input type="text" class="form-control" id="passportSeries" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏—é –ø–∞—Å–ø–æ—Ä—Ç–∞">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="passportNumber" class="form-label">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                                        <input type="text" class="form-control" id="passportNumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="passportIssueDate" class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                                        <input type="date" class="form-control" id="passportIssueDate">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="passportIssuePlace" class="form-label">–ú–µ—Å—Ç–æ –≤—ã–¥–∞—á–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                                        <input type="text" class="form-control" id="passportIssuePlace" placeholder="–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ –≤—ã–¥–∞—á–∏">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- –û–ø–ª–∞—Ç–∞ -->
                <div class="accordion mt-3" id="accordionPayment">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="paymentHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#paymentCollapse" aria-expanded="false" aria-controls="paymentCollapse">
                                –û–ø–ª–∞—Ç–∞
                            </button>
                        </h2>
                        <div id="paymentCollapse" class="accordion-collapse collapse" aria-labelledby="paymentHeading" data-bs-parent="#accordionPayment">
                            <div class="accordion-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="totalAmount" class="form-label">–û–±—â–∞—è —Å—É–º–º–∞</label>
                                        <input type="number" class="form-control" id="totalAmount" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="paymentMonths" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤</label>
                                        <input type="number" class="form-control" id="paymentMonths" min="0" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="paymentStartDate" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞</label>
                                        <input type="date" class="form-control" id="paymentStartDate">
                                    </div>
                                </div>
                                <!-- –ü–æ—Å–ª–µ –±–ª–æ–∫–∞ –æ–ø–ª–∞—Ç—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –æ–ø–ª–∞—Ç—ã -->
                                <div id="paidMonthsContainer" class="mb-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- –ó–∞–¥–∞—á–∏ -->
                <h5 class="mb-3 mt-3">–ó–∞–¥–∞—á–∏</h5>
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="taskText" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É">
                        <select class="form-select" id="taskPriority">
                            <option value="low">–ù–∏–∑–∫–∞—è</option>
                            <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                            <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                        </select>
                        <input type="date" class="form-control" id="taskDeadline" placeholder="–î–µ–¥–ª–∞–π–Ω">
                        <button class="btn btn-primary" onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>
                <ul class="list-group" id="taskList"></ul>
                <div id="taskHistory" class="mt-3" style="display:none;">
                    <h5>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á</h5>
                    <div id="currentStageInfo" class="mb-2"></div>
                    <ul class="list-group" id="completedTaskList"></ul>
                </div>
                <!-- –î–µ–ª–æ -->
                <div class="accordion mt-3" id="accordionCase">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="caseHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#caseCollapse" aria-expanded="false" aria-controls="caseCollapse">
                                –°—É–¥–µ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
                            </button>
                        </h2>
                        <div id="caseCollapse" class="accordion-collapse collapse" aria-labelledby="caseHeading" data-bs-parent="#accordionCase">
                            <div class="accordion-body">
                                <div class="mb-3 d-flex align-items-end">
                                    <div class="flex-grow-1">
                                        <label for="arbitrLink" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—Ä–±–∏—Ç—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                        <input type="url" class="form-control" id="arbitrLink" placeholder="https://example.com">
                                    </div>
                                    <button class="arbitr-icon ms-2" id="arbitrButton" disabled>‚óâ</button>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="caseNumber" class="form-label">–ù–æ–º–µ—Ä –¥–µ–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                        <input type="text" class="form-control" id="caseNumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–ª–∞">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="stage" class="form-label">–≠—Ç–∞–ø</label>
                                        <select class="form-select" id="stage" required>
                                            <option value="" disabled>–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø</option>
                                            <option value="–î–æ–≥–æ–≤–æ—Ä">–î–æ–≥–æ–≤–æ—Ä</option>
                                            <option value="–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥">–ü–æ–¥–∞—á–∞ –≤ —Å—É–¥</option>
                                            <option value="–†–µ—à–µ–Ω–∏–µ —Å—É–¥–∞ –æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ">–†–µ—à–µ–Ω–∏–µ —Å—É–¥–∞ –æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ</option>
                                            <option value="–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="subStage" class="form-label">–ó–∞–¥–∞—á–∞</label>
                                        <select class="form-select" id="subStage">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="courtDate" class="form-label">–î–∞—Ç–∞ —Å—É–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                    <input type="date" class="form-control" id="courtDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                <h5 class="mb-3 mt-3">–ó–∞–º–µ—Ç–∫–∏</h5>
                <div class="mb-3">
                    <label for="notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <textarea class="form-control" id="notes" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫–∏"></textarea>
                </div>
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="d-flex gap-2">
                    <button class="btn btn-success w-50" onclick="updateClient()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    <button class="btn btn-danger w-25" onclick="deleteClient()">–£–¥–∞–ª–∏—Ç—å</button>
                    <a href="index.html" class="btn btn-outline-secondary w-25">–û—Ç–º–µ–Ω–∞</a>
                    <button id="completeClientBtn" class="btn btn-complete w-100 mt-2" style="display:none;" onclick="completeClientFromEdit()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –æ–ø–ª–∞—Ç—ã
    document.getElementById('paymentMonths').addEventListener('input', function() {
        const months = parseInt(this.value) || 0;
        const container = document.getElementById('paidMonthsContainer');
        container.innerHTML = '';
        for (let i = 1; i <= months; i++) {
            container.innerHTML += `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="paidMonth${i}">
                    <label class="form-check-label" for="paidMonth${i}">–ú–µ—Å—è—Ü ${i}</label>
                </div>
            `;
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    const favoriteBtn = document.getElementById('favoriteBtn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
            const fav = favoriteBtn.dataset.favorite === 'true';
            favoriteBtn.dataset.favorite = (!fav).toString();
            favoriteBtn.textContent = fav ? '‚òÜ' : '‚òÖ';
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
    function initTaskList(clientId) {
        const clients = JSON.parse(localStorage.getItem('clients')) || [];
        const client = clients.find(c => c.id === parseInt(clientId));
        window.tasks = client && client.tasks ? client.tasks : [];
        renderTaskList();
    }
    function addTask() {
        const text = document.getElementById('taskText').value.trim();
        const priority = document.getElementById('taskPriority').value;
        const deadline = document.getElementById('taskDeadline').value;
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏!');
            return;
        }
        const task = {
            id: Date.now(),
            text,
            priority,
            deadline,
            completed: false
        };
        window.tasks.push(task);
        renderTaskList();
        document.getElementById('taskText').value = '';
        document.getElementById('taskDeadline').value = '';
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á–∏ –≤ –∫–ª–∏–µ–Ω—Ç–µ
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = parseInt(urlParams.get('id'));
        const clients = JSON.parse(localStorage.getItem('clients')) || [];
        const clientIndex = clients.findIndex(c => c.id === clientId);
        if (clientIndex !== -1) {
            clients[clientIndex].tasks = window.tasks;
            localStorage.setItem('clients', JSON.stringify(clients));
        }
    }
    function renderTaskList() {
        const list = document.getElementById('taskList');
        list.innerHTML = '';
        window.tasks.forEach((task, idx) => {
            const li = document.createElement('li');
            li.className = `list-group-item d-flex justify-content-between align-items-center task-${task.priority}`;
            li.innerHTML = `
                ${task.text} (${task.deadline ? task.deadline : '–ë–µ–∑ —Å—Ä–æ–∫–∞'}) 
                <button class="btn btn-sm btn-danger" onclick="removeTask(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
            `;
            list.appendChild(li);
        });
    }
    function removeTask(idx) {
        window.tasks.splice(idx, 1);
        renderTaskList();
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á–∏ –≤ –∫–ª–∏–µ–Ω—Ç–µ
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = parseInt(urlParams.get('id'));
        const clients = JSON.parse(localStorage.getItem('clients')) || [];
        const clientIndex = clients.findIndex(c => c.id === clientId);
        if (clientIndex !== -1) {
            clients[clientIndex].tasks = window.tasks;
            localStorage.setItem('clients', JSON.stringify(clients));
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const stageSelect = document.getElementById('stage');
        const subStageSelect = document.getElementById('subStage');
        const completeBtn = document.getElementById('completeClientBtn');
        function updateCompleteBtnVisibility() {
            completeBtn.style.display =
                stageSelect.value === '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ' && subStageSelect.value === '–∂–¥–µ–º –¥–æ–∫–∏ –æ—Ç —Å—É–¥–∞'
                    ? 'block'
                    : 'none';
        }
        if (stageSelect && completeBtn && subStageSelect) {
            stageSelect.addEventListener('change', updateCompleteBtnVisibility);
            subStageSelect.addEventListener('change', updateCompleteBtnVisibility);
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateCompleteBtnVisibility();
        }
        window.completeClientFromEdit = function() {
            const clientId = parseInt(document.getElementById('clientId').value);
            if (!clientId) return;
            if (confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) {
                if (window.completeClient) {
                    window.completeClient(clientId);
                } else {
                    alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
            }
        };
    });
    </script>
</body>
</html>